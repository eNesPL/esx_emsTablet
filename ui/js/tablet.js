var dictHumanReadable = {
  Everything: "Całe ciało",
  SKEL_Pelvis: "Miednica",
  SKEL_L_Thigh: "Lewe udo",
  SKEL_L_Calf: "Lewa łydka",
  SKEL_L_Foot: "Lewa stopa",
  IK_L_Foot: "Lewa stopa",
  PH_L_Foot: "Lewa stopa",
  MH_L_Knee: "Lewe kolano",
  SKEL_R_Thigh: "Prawe udo",
  SKEL_R_Calf: "Prawa łydka",
  SKEL_R_Foot: "Prawa stopa",
  IK_R_Foot: "Prawa stopa",
  PH_R_Foot: "Prawa stopa",
  MH_R_Knee: "Prawe kolano",
  RB_L_ThighRoll: "Lewa łydka",
  RB_R_ThighRoll: "Prawa łydka",
  SKEL_Spine_Root: "Plecy",
  SKEL_Spine0: "Klatka piersiowa",
  SKEL_Spine1: "Klatka piersiowa",
  SKEL_Spine2: "Klatka piersiowa",
  SKEL_Spine3: "Klatka piersiowa",
  SKEL_L_Clavicle: "Lewa łopatka",
  SKEL_L_UpperArm: "Lewe ramie",
  SKEL_L_Forearm: "Lewe przedramie",
  SKEL_L_Hand: "Lewa dłoń",
  IK_L_Hand: "Lewa dłoń",
  PH_L_Hand: "Lewa dłoń",
  MH_L_Elbow: "Lewy łokieć",
  RB_L_ForeArmRoll: "Lewe przedramie",
  RB_L_ArmRoll: "Lewe ramie",
  SKEL_R_Clavicle: "Prawa łopatka",
  SKEL_R_UpperArm: "Prawe ramie",
  SKEL_R_Forearm: "Prawe przedramie",
  SKEL_R_Hand: "Prawa dłoń",
  IK_R_Hand: "Prawa dłoń",
  PH_R_Hand: "Prawa dłoń",
  MH_R_Elbow: "Prawy łokieć",
  RB_R_ForeArmRoll: "Prawe przedramie",
  RB_R_ArmRoll: "Prawe ramie",
  SKEL_Neck_1: "Kark",
  SKEL_Head: "Głowa",
  IK_Head: "Głowa",
  FACIAL_facialRoot: "Głowa",
  FB_L_Brow_Out_000: "Głowa",
  FB_L_Lid_Upper_000: "Głowa",
  FB_L_Eye_000: "Głowa",
  FB_L_CheekBone_000: "Głowa",
  FB_L_Lip_Corner_000: "Głowa",
  FB_R_Lid_Upper_000: "Głowa",
  FB_R_Eye_000: "Głowa",
  FB_R_CheekBone_000: "Głowa",
  FB_R_Brow_Out_000: "Głowa",
  FB_R_Lip_Corner_000: "Głowa",
  FB_Brow_Centre_000: "Głowa",
  FB_UpperLipRoot_000: "Głowa",
  FB_UpperLip_000: "Głowa",
  FB_L_Lip_Top_000: "Głowa",
  FB_R_Lip_Top_000: "Głowa",
  FB_Jaw_000: "Głowa",
  FB_LowerLipRoot_000: "Głowa",
  FB_LowerLip_000: "Głowa",
  FB_L_Lip_Bot_000: "Głowa",
  FB_R_Lip_Bot_000: "Głowa",
  FB_Tongue_000: "Głowa",
  RB_Neck_1: "Kark",
  IK_Root: "Całe ciało",
};

var dictUI = {
  Everything: "Everything",
  SKEL_Pelvis: "belly",
  SKEL_L_Thigh: "thigh-left",
  SKEL_L_Calf: "calf-left",
  SKEL_L_Foot: "feet-left",
  IK_L_Foot: "feet-left",
  PH_L_Foot: "feet-left",
  MH_L_Knee: "knee-left",
  SKEL_R_Thigh: "thigh-right",
  SKEL_R_Calf: "calf-right",
  SKEL_R_Foot: "feet-right",
  IK_R_Foot: "feet-right",
  PH_R_Foot: "feet-right",
  MH_R_Knee: "knee-right",
  RB_L_ThighRoll: "thigh-left",
  RB_R_ThighRoll: "thigh-right",
  SKEL_Spine_Root: "chest",
  SKEL_Spine0: "belly",
  SKEL_Spine1: "ribs",
  SKEL_Spine2: "chest",
  SKEL_Spine3: "chest",
  SKEL_L_Clavicle: "shoulder-left",
  SKEL_L_UpperArm: "arm-left",
  SKEL_L_Forearm: "forearm-left",
  SKEL_L_Hand: "hand-left",
  IK_L_Hand: "hand-left",
  PH_L_Hand: "hand-left",
  MH_L_Elbow: "elbow-left",
  RB_L_ForeArmRoll: "forearm-left",
  RB_L_ArmRoll: "arm-left",
  SKEL_R_Clavicle: "shoulder-right",
  SKEL_R_UpperArm: "arm-right",
  SKEL_R_Forearm: "forearm-right",
  SKEL_R_Hand: "hand-right",
  IK_R_Hand: "hand-right",
  PH_R_Hand: "hand-right",
  MH_R_Elbow: "elbow-right",
  RB_R_ForeArmRoll: "forearm-right",
  RB_R_ArmRoll: "arm-right",
  SKEL_Neck_1: "neck",
  SKEL_Head: "head",
  IK_Head: "head",
  FACIAL_facialRoot: "head",
  FB_L_Brow_Out_000: "head",
  FB_L_Lid_Upper_000: "head",
  FB_L_Eye_000: "head",
  FB_L_CheekBone_000: "head",
  FB_L_Lip_Corner_000: "head",
  FB_R_Lid_Upper_000: "head",
  FB_R_Eye_000: "head",
  FB_R_CheekBone_000: "head",
  FB_R_Brow_Out_000: "head",
  FB_R_Lip_Corner_000: "head",
  FB_Brow_Centre_000: "head",
  FB_UpperLipRoot_000: "head",
  FB_UpperLip_000: "head",
  FB_L_Lip_Top_000: "head",
  FB_R_Lip_Top_000: "head",
  FB_Jaw_000: "head",
  FB_LowerLipRoot_000: "head",
  FB_LowerLip_000: "head",
  FB_L_Lip_Bot_000: "head",
  FB_R_Lip_Bot_000: "head",
  FB_Tongue_000: "head",
  RB_Neck_1: "neck",
  IK_Root: "everything",
};


function SetPanel() {
  document.getElementById("panel").style.display = "flex";
  document.getElementById("pacjent").style.display = "none";
  document.getElementById("dispatch").style.display = "none";
  document.getElementById("tabpacjent").classList.remove("active");
  document.getElementById("tabpanel").classList.add("active");
  document.getElementById("tabdispatch").classList.remove("active");
}

function SetDispatch() {
  document.getElementById("panel").style.display = "none";
  document.getElementById("pacjent").style.display = "none";
  document.getElementById("dispatch").style.display = "flex";
  document.getElementById("tabpacjent").classList.remove("active");
  document.getElementById("tabpanel").classList.remove("active");
  document.getElementById("tabdispatch").classList.add("active");
}




window.addEventListener("message", (event) => {
  //console.log(event.data.type)
  //console.log(event.data.display)
  if (event.data.type === "ui") {
    if (event.data.display == true) {
      $("#showpanel").show();
      document.getElementById("showpanel").style.display = "flex";
      SetDispatch();
    }
    else {
      $("#showpanel").hide();
      document.getElementById("showpanel").style.display = "none";
    }
  } 
  if(item.action == 'dodajWezwanie'){
    if(item.open == 1) {
        var style = 'style="background-color:#f44335;"';
    }
    else{
        var style = '';
    }
    $("#wezwania").append('<tr id="wezwanie-'+item.id+'" '+style+'><td>'+item.wezwanie_wzywajacy+'</td><td>'+item.wezwanie_wiadomosc+'</td><td><div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Akcja</button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton"><a class="dropdown-item" href="#" onclick="oznaczGPS(\''+item.x+'\', \''+item.y+'\', \''+item.z+'\');">Oznacz na GPS</a><a class="dropdown-item" href="#" onclick="ZakonczWezwanie(\''+item.id+'\');">Zakończ wezwanie</a></div></div></td></tr>');
}
});

function ZakonczWezwanie(id){
  $("#wezwanie-"+id).css("background-color", "#f44335")
  return $.post(`https://tablet_policyjny/zakonczWezwanie`, JSON.stringify({id : id }));
}

function oznaczGPS(x, y, z){
  return $.post(`https://tablet_policyjny/oznaczGPS`, JSON.stringify({x: x, y: y, z: z}));

}
document.onkeyup = data => {
  if (data.key === "Escape") {
    $("showpanel").fadeOut(500);
    document.getElementById("showpanel").style.display = "none";
    $.post('https://esx_emsTablet/closeUi');
    $("#lista").empty();
    ChangeColorBack();
  }
};


function SetPacjent() {
  document.getElementById("panel").style.display = "none";
  document.getElementById("pacjent").style.display = "flex";
  document.getElementById("dispatch").style.display = "none";
  document.getElementById("tabpacjent").classList.add("active");
  document.getElementById("tabpanel").classList.remove("active");
  document.getElementById("tabdispatch").classList.remove("active");
}

function ChangeColorBack() {
  for (var i = 0; i < Object.keys(dictUI).length; i++) {
    var divs = document.getElementsByClassName(Object.values(dictUI)[i]);
    for (var j = 0; j < divs.length; j++) {
      divs[j].style.fill = "white";
    }
  }
}
function ChangeColor(name) {
  var divs = document.getElementsByClassName(dictUI[name]);
  for (var i = 0; i < divs.length; i++) {
    divs[i].style.fill = "red";
  }
}

function populateInjuries(injuries) {
  try {
    Injuries = JSON.parse(injuries);
} catch (e) {
    Injuries = injuries;
}

  //console.log(Injuries)
  //console.log(Injuries.length)
  //for each injury in the injuries table, create a new div with the injury name and damage type
  for (var i = 0; i < Injuries.length; i++) {
    $("#lista").append(
      "<div class='injury' id='injury" +
      i +
      "'>" +
      dictHumanReadable[Injuries[i].Name] + " - " +
      Injuries[i].Name +
      " - <span style='color: green;'>" +
      Injuries[i].DamageType +
      "</span></div>"
    );
    ChangeColor(Injuries[i].Name);
  }
}
function Heal_btn(){
  Heal()
}
function Heal(){
  var id = document.getElementById("id").value;
  fetch(`https://esx_emsTablet/Heal`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json; charset=UTF-8',
    },
    body: JSON.stringify({
      playerid: id
  })
}).then(resp => handleHeal(resp));

}
function getInjuriesFromId_btn(){
  getInjuriesFromId()
}
function getInjuriesFromId(){
  //console.log("UUUU")
  $("#lista").empty();
  ChangeColorBack();
  var id = document.getElementById("id").value;
  //console.log(id);
  if(isNumber(id)){
  fetch(`https://esx_emsTablet/GetInjuries`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json; charset=UTF-8',
    },
    body: JSON.stringify({
      playerid: id
  })
}).then(res => res.text())
.then(body => {
    try {
        //console.log(body)
        handleResp(JSON.parse(body));
    } catch {
        throw Error(body);
    }
})
.catch(console.error);
}
else{
  $("#lista").append(
    "<div class='injury' id='injury'>Niepoprawne ID</div>"
  );
}
};

function isNumber(n) { return /^-?[\d.]+(?:e-?\d+)?$/.test(n); }
function isJson(str) {
  try {
      JSON.parse(str);
  } catch (e) {
      return false;
  }
  return true;
}

function handleHeal(resp){
    if(isJson(resp)){
    resp = JSON.parse(resp);
    if(resp == true){
    $("#lista").empty();
    ChangeColorBack();
    if (resp.length > 0 && resp != null ) {
      populateInjuries(resp);
    }
    else {
      $("#lista").append(
        "<div class='injury' id='injury'>Brak obrażeń</div>"
      );
    }
    SetPacjent();
  }
  else{
    $("#lista").append(
      "<div class='injury' id='injury'>Niepoprawne ID</div>"
    );
  }
}
}

function handleResp(resp){
    //console.log("RESP? " + resp);
    if(resp.length != 0){
    resp = JSON.parse(resp);
    //console.log(resp.length)
    $("#lista").empty();
    ChangeColorBack();
    //console.log(resp.length)
    if (resp.length > 0 && resp != null ) {
      //console.log("jest")
      populateInjuries(resp);
    }
    else {
      //console.log("nie ma")
      $("#lista").append(
        "<div class='injury' id='injury'>Brak obrażeń</div>"
      );
    }
    SetPacjent();
  }
  else{
    $("#lista").append(
      "<div class='injury' id='injury'>Brak obrażeń</div>"
    );
  }
}

